import "trilogy:io" use println
import "trilogy:array" use length

export test_main

proc test_main!(tests) {
  let mut successes = 0
  let mut failures = 0

  println!($"running ${length tests} tests\n")

  for test_name:test_procedure in tests {
    print!($"${test_name} ... ")
    with test_procedure!()
      else eff then {
        println!($"failure: unhandled effect yielded from test: ${eff}")
        failures += 1
        continue
      }
    println!("ok")
    successes += 1
  }
  let result = if failures == 0 then "ok" else "failure"
  println!($"\ntest result: ${result}. ${successes} passed; ${failures} failed")

  if failures != 0 {
    exit 1
  }
  exit 0
}
